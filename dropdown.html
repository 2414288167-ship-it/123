<div id="idle_container">
  <div class="idle_block">
    <label class="checkbox-container">
      <input type="checkbox" id="aam_enabled" checked>
      <span class="checkmark"></span> 启用自动消息
    </label>
  </div>

  <details>
    <summary>模式设置</summary>
    <div class="idle_block">
      <label class="checkbox-container">
        <input type="checkbox" id="aam_fixed_mode" checked>
        <span class="checkmark"></span> 定时模式（特定时间点）
      </label>
      <label class="checkbox-container">
        <input type="checkbox" id="aam_random_mode">
        <span class="checkmark"></span> 随机模式
      </label>
    </div>
  </details>

  <details id="fixed_mode_settings">
    <summary>定时模式配置</summary>
    <div class="idle_block">
      <label>每日发送时间点：</label>
      <div class="time-points" id="time_points_container"></div>
      <button class="idle_btn" id="add_time_point">+ 添加时间点</button>
      <small>格式：小时（0-23）:分钟（0-59）</small>
    </div>
  </details>

  <details id="random_mode_settings">
    <summary>随机模式配置</summary>
    <div class="idle_block">
      <label for="aam_min_random">最小间隔（秒）：</label>
      <input type="number" id="aam_min_random" min="5" max="300" value="10">
      
      <label for="aam_max_random">最大间隔（秒）：</label>
      <input type="number" id="aam_max_random" min="5" max="300" value="60">
    </div>
  </details>

  <details>
    <summary>通用设置</summary>
    <div class="idle_block">
      <label for="aam_min_gap">最小消息间隔（秒）：</label>
      <input type="number" id="aam_min_gap" min="3" max="60" value="5">
      
      <label class="checkbox-container">
        <input type="checkbox" id="aam_only_idle" checked>
        <span class="checkmark"></span> 仅当用户闲置时发送
      </label>
    </div>
  </details>

  <details>
    <summary>提示词设置</summary>
    <div class="idle_block">
      <label for="aam_prompts">自动消息提示词（每行一个）：</label>
      <textarea id="aam_prompts" rows="4">基于之前的对话，自然地继续交流吧。
有什么想聊的吗？我很乐意继续。
接着刚才的话题，你觉得呢？</textarea>
      <small>AI会随机选择一个提示词生成回复</small>
    </div>
  </details>

  <div class="idle_block">
    <button class="idle_btn" id="save_aam_settings">保存设置</button>
  </div>

  <div class="idle-next-time" id="next_send_time">
    下一次预计发送时间：计算中...
  </div>
</div>

<script>
  // 加载配置到UI
  function populateUI() {
    const settings = window.autoAiMessage.getSettings();
    
    document.getElementById("aam_enabled").checked = settings.enabled;
    document.getElementById("aam_fixed_mode").checked = settings.enableFixedMode;
    document.getElementById("aam_random_mode").checked = settings.enableRandomMode;
    document.getElementById("aam_min_random").value = settings.minRandomInterval;
    document.getElementById("aam_max_random").value = settings.maxRandomInterval;
    document.getElementById("aam_min_gap").value = settings.minMessageGap;
    document.getElementById("aam_only_idle").checked = settings.onlyWhenIdle;
    document.getElementById("aam_prompts").value = settings.prompts.join('\n');
    
    renderTimePoints(settings.fixedTimes);
    updateNextSendTime();
  }

  // 渲染时间点
  function renderTimePoints(times) {
    const container = document.getElementById("time_points_container");
    container.innerHTML = "";
    
    times.forEach((time, index) => {
      const div = document.createElement("div");
      div.className = "time-point";
      div.innerHTML = `
        <input type="number" class="time-input hour" min="0" max="23" value="${time.hour}">
        <span>:</span>
        <input type="number" class="time-input minute" min="0" max="59" value="${time.minute}">
        <button class="idle_btn delete-time" data-index="${index}">删除</button>
      `;
      container.appendChild(div);
    });
    
    // 绑定删除事件
    document.querySelectorAll(".delete-time").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const index = parseInt(e.target.dataset.index);
        const settings = window.autoAiMessage.getSettings();
        settings.fixedTimes.splice(index, 1);
        renderTimePoints(settings.fixedTimes);
      });
    });
  }

  // 添加时间点
  document.getElementById("add_time_point").addEventListener("click", () => {
    const settings = window.autoAiMessage.getSettings();
    settings.fixedTimes.push({ hour: 12, minute: 0 });
    renderTimePoints(settings.fixedTimes);
  });

  // 更新下次发送时间提示
  function updateNextSendTime() {
    // 简化实现，实际可复用index.js中的计算逻辑
    document.getElementById("next_send_time").textContent = "下一次预计发送时间：计算中...";
  }

  // 保存设置
  document.getElementById("save_aam_settings").addEventListener("click", () => {
    const settings = window.autoAiMessage.getSettings();
    
    // 收集UI配置
    settings.enabled = document.getElementById("aam_enabled").checked;
    settings.enableFixedMode = document.getElementById("aam_fixed_mode").checked;
    settings.enableRandomMode = document.getElementById("aam_random_mode").checked;
    settings.minRandomInterval = parseInt(document.getElementById("aam_min_random").value);
    settings.maxRandomInterval = parseInt(document.getElementById("aam_max_random").value);
    settings.minMessageGap = parseInt(document.getElementById("aam_min_gap").value);
    settings.onlyWhenIdle = document.getElementById("aam_only_idle").checked;
    settings.prompts = document.getElementById("aam_prompts").value.split('\n').filter(p => p.trim());
    
    // 收集时间点
    const timeInputs = document.querySelectorAll(".time-point");
    settings.fixedTimes = Array.from(timeInputs).map(el => ({
      hour: parseInt(el.querySelector(".hour").value) || 0,
      minute: parseInt(el.querySelector(".minute").value) || 0
    }));
    
    // 验证配置
    if (settings.enabled && !settings.enableFixedMode && !settings.enableRandomMode) {
      alert("请至少启用一种模式");
      return;
    }
    if (settings.enableRandomMode && settings.minRandomInterval > settings.maxRandomInterval) {
      alert("最小间隔不能大于最大间隔");
      return;
    }
    
    // 同步到扩展
    window.autoAiMessage.updateFromUI();
    alert("设置已保存");
    updateNextSendTime();
  });

  // 初始化UI
  populateUI();
</script>
