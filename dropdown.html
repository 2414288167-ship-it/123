<div id="123123_container">
    <!-- 基础开关 -->
    <div class="auto_block">
        <label class="checkbox-container">
            <input type="checkbox" id="123123_enabled" checked>
            <span class="checkmark"></span> 启用自动消息
        </label>
    </div>

    <!-- 模式选择 -->
    <div class="auto_block">
        <label>触发模式：</label>
        <div class="sub_block">
            <label class="checkbox-container">
                <input type="checkbox" id="123123_mode_idle" checked>
                <span class="checkmark"></span> 闲置触发
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="123123_mode_fixed">
                <span class="checkmark"></span> 定时触发（每日固定时间）
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="123123_mode_interval">
                <span class="checkmark"></span> 间隔触发（随机时间）
            </label>
        </div>
    </div>

    <!-- 闲置模式配置 -->
    <div class="auto_block" id="123123_idle_settings">
        <label for="123123_timer">闲置时间（秒）：</label>
        <input type="number" id="123123_timer" min="10" value="300">
        
        <label class="checkbox-container">
            <input type="checkbox" id="123123_random">
            <span class="checkmark"></span> 随机波动（±30%）
        </label>
    </div>

    <!-- 定时模式配置 -->
    <div class="auto_block" id="123123_fixed_settings" style="display: none;">
        <label>每日发送时间点：</label>
        <div class="time_points" id="123123_fixed_time_points"></div>
        <button class="auto_btn" id="123123_add_fixed_time">+ 添加时间点</button>
        <small>格式：小时（0-23）:分钟（0-59）</small>
    </div>

    <!-- 间隔模式配置 -->
    <div class="auto_block" id="123123_interval_settings" style="display: none;">
        <label for="123123_interval_min">最小间隔（秒）：</label>
        <input type="number" id="123123_interval_min" min="10" value="60">
        
        <label for="123123_interval_max">最大间隔（秒）：</label>
        <input type="number" id="123123_interval_max" min="10" value="300">
    </div>

    <!-- 通用配置 -->
    <div class="auto_block">
        <label for="123123_prompts">提示词（每行一个）：</label>
        <textarea id="123123_prompts" rows="3">我们继续聊刚才的话题吧？
有什么新想法吗？
你觉得接下来会发生什么？</textarea>
    </div>

    <!-- 保存按钮 -->
    <div class="auto_block">
        <button class="auto_btn" id="123123_save_settings">保存设置</button>
    </div>
</div>

<style>
.auto_block {
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.sub_block {
    margin-left: 20px;
}

.checkbox-container {
    display: block;
    margin: 5px 0;
}

.time_points {
    margin: 10px 0;
}

.time_point {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.time_input {
    width: 50px;
    margin: 0 5px;
}

.auto_btn {
    margin: 5px;
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
}

.auto_btn:hover {
    background: #45a049;
}

.delete_time {
    background: #f44336;
}

.delete_time:hover {
    background: #da190b;
}
</style>

<script>
    // 初始化：从扩展实例加载数据到UI
    function populateUIFromSettings() {
        const extension = window.extensions?.getExtension("123123");
        const settings = extension?.getSettings() || {
            enabled: true,
            enableFixedMode: false,
            enableRandomMode: false,
            fixedTimes: [],
            minRandomInterval: 60,
            maxRandomInterval: 300,
            prompts: [
                "我们继续聊刚才的话题吧？",
                "有什么新想法吗？",
                "你觉得接下来会发生什么？"
            ]
        };

        // 基础开关
        document.getElementById("123123_enabled").checked = settings.enabled;

        // 模式选择
        document.getElementById("123123_mode_fixed").checked = settings.enableFixedMode;
        document.getElementById("123123_mode_interval").checked = settings.enableRandomMode;

        // 间隔模式配置
        document.getElementById("123123_interval_min").value = settings.minRandomInterval;
        document.getElementById("123123_interval_max").value = settings.maxRandomInterval;

        // 提示词
        document.getElementById("123123_prompts").value = settings.prompts?.join("\n") || "";

        // 渲染定时时间点
        renderFixedTimePoints(settings.fixedTimes || []);

        // 更新UI显示状态
        toggleSettingsVisibility();
    }

    // 渲染定时时间点列表
    function renderFixedTimePoints(times) {
        const container = document.getElementById("123123_fixed_time_points");
        container.innerHTML = "";

        times.forEach((time, index) => {
            const timeEl = document.createElement("div");
            timeEl.className = "time_point";
            timeEl.innerHTML = `
                <input type="number" class="time_input hour" min="0" max="23" value="${time.hour || 0}">
                <span>:</span>
                <input type="number" class="time_input minute" min="0" max="59" value="${time.minute || 0}">
                <button class="auto_btn delete_time" data-index="${index}">删除</button>
            `;
            container.appendChild(timeEl);
        });

        // 绑定删除按钮事件
        document.querySelectorAll(".delete_time").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const extension = window.extensions.getExtension("123123");
                if (extension) {
                    const settings = extension.getSettings();
                    settings.fixedTimes.splice(e.target.dataset.index, 1);
                    renderFixedTimePoints(settings.fixedTimes);
                }
            });
        });
    }

    // 切换配置块显示/隐藏
    function toggleSettingsVisibility() {
        const fixedMode = document.getElementById("123123_mode_fixed").checked;
        const intervalMode = document.getElementById("123123_mode_interval").checked;

        document.getElementById("123123_fixed_settings").style.display = 
            fixedMode ? "block" : "none";
        document.getElementById("123123_interval_settings").style.display = 
            intervalMode ? "block" : "none";
    }

    // 初始化事件监听
    function initializeEventListeners() {
        // 模式切换
        document.getElementById("123123_mode_fixed").addEventListener("change", toggleSettingsVisibility);
        document.getElementById("123123_mode_interval").addEventListener("change", toggleSettingsVisibility);

        // 添加时间点
        document.getElementById("123123_add_fixed_time").addEventListener("click", () => {
            const extension = window.extensions.getExtension("123123");
            if (extension) {
                const settings = extension.getSettings();
                settings.fixedTimes = settings.fixedTimes || [];
                settings.fixedTimes.push({ hour: 12, minute: 0 });
                renderFixedTimePoints(settings.fixedTimes);
            }
        });

        // 保存设置
        document.getElementById("123123_save_settings").addEventListener("click", () => {
            const extension = window.extensions.getExtension("123123");
            if (!extension) {
                alert("扩展未正确加载，请刷新页面重试");
                return;
            }

            const settings = extension.getSettings();

            // 1. 基础配置更新
            settings.enabled = document.getElementById("123123_enabled").checked;
            settings.enableFixedMode = document.getElementById("123123_mode_fixed").checked;
            settings.enableRandomMode = document.getElementById("123123_mode_interval").checked;

            // 2. 间隔模式配置更新
            settings.minRandomInterval = parseInt(document.getElementById("123123_interval_min").value) || 60;
            settings.maxRandomInterval = parseInt(document.getElementById("123123_interval_max").value) || 300;

            // 3. 提示词更新
            settings.prompts = document.getElementById("123123_prompts").value
                .split("\n")
                .map(p => p.trim())
                .filter(p => p);

            // 4. 定时模式：更新时间点列表
            const timePoints = Array.from(document.querySelectorAll(".time_point")).map(el => ({
                hour: parseInt(el.querySelector(".hour").value) || 0,
                minute: parseInt(el.querySelector(".minute").value) || 0
            }));
            settings.fixedTimes = timePoints;

            // 5. 验证配置合法性
            const errors = [];
            if (settings.enableRandomMode && settings.minRandomInterval > settings.maxRandomInterval) {
                errors.push("最小间隔不能大于最大间隔");
            }
            if (settings.prompts.length === 0) {
                errors.push("提示词不能为空，请至少输入一条");
            }
            if (settings.enableFixedMode && settings.fixedTimes.length === 0) {
                errors.push("定时模式需添加至少一个时间点");
            }

            // 验证失败：显示错误信息
            if (errors.length > 0) {
                alert("保存失败：\n" + errors.join("\n"));
                return;
            }

            // 6. 保存配置
            extension.updateFromUI();
            alert("设置已保存");
        });
    }

    // 页面加载完成后初始化
    document.addEventListener("DOMContentLoaded", () => {
        populateUIFromSettings();
        initializeEventListeners();
    });
</script>
